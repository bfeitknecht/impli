var C=class R{static read_bytes(r,a){let o=new R;return o.buf=r.getUint32(a,!0),o.buf_len=r.getUint32(a+4,!0),o}static read_bytes_array(r,a,o){let E=[];for(let t=0;t<o;t++)E.push(R.read_bytes(r,a+8*t));return E}},g=class R{static read_bytes(r,a){let o=new R;return o.buf=r.getUint32(a,!0),o.buf_len=r.getUint32(a+4,!0),o}static read_bytes_array(r,a,o){let E=[];for(let t=0;t<o;t++)E.push(R.read_bytes(r,a+8*t));return E}};var P=2;var A=class{write_bytes(r,a){r.setUint8(a,this.fs_filetype),r.setUint16(a+2,this.fs_flags,!0),r.setBigUint64(a+8,this.fs_rights_base,!0),r.setBigUint64(a+16,this.fs_rights_inherited,!0)}constructor(r,a){this.fs_rights_base=0n,this.fs_rights_inherited=0n,this.fs_filetype=r,this.fs_flags=a}};var y=class{write_bytes(r,a){r.setBigUint64(a,this.dev,!0),r.setBigUint64(a+8,this.ino,!0),r.setUint8(a+16,this.filetype),r.setBigUint64(a+24,this.nlink,!0),r.setBigUint64(a+32,this.size,!0),r.setBigUint64(a+38,this.atim,!0),r.setBigUint64(a+46,this.mtim,!0),r.setBigUint64(a+52,this.ctim,!0)}constructor(r,a,o){this.dev=0n,this.nlink=0n,this.atim=0n,this.mtim=0n,this.ctim=0n,this.ino=r,this.filetype=a,this.size=o}},M=0;var Z=1,L=class R{static read_bytes(r,a){return new R(r.getBigUint64(a,!0),r.getUint8(a+8),r.getUint32(a+16,!0),r.getBigUint64(a+24,!0),r.getUint16(a+36,!0))}constructor(r,a,o,E,t){this.userdata=r,this.eventtype=a,this.clockid=o,this.timeout=E,this.flags=t}},U=class{write_bytes(r,a){r.setBigUint64(a,this.userdata,!0),r.setUint16(a+8,this.error,!0),r.setUint8(a+10,this.eventtype)}constructor(r,a,o){this.userdata=r,this.error=a,this.eventtype=o}};var J=class{enable(r){this.log=Q(r===void 0?!0:r,this.prefix)}get enabled(){return this.isEnabled}constructor(r){this.isEnabled=r,this.prefix="wasi:",this.enable(r)}};function Q(R,r){return R?console.log.bind(console,"%c%s","color: #265BA0",r):()=>{}}var S=new J(!1);var b=class extends Error{constructor(r){super("exit with exit code "+r),this.code=r}},z=class{start(r){this.inst=r;try{return r.exports._start(),0}catch(a){if(a instanceof b)return a.code;throw a}}initialize(r){this.inst=r,r.exports._initialize&&r.exports._initialize()}constructor(r,a,o,E={}){this.args=[],this.env=[],this.fds=[],S.enable(E.debug),this.args=r,this.env=a,this.fds=o;let t=this;this.wasiImport={args_sizes_get(e,s){let n=new DataView(t.inst.exports.memory.buffer);n.setUint32(e,t.args.length,!0);let i=0;for(let _ of t.args)i+=_.length+1;return n.setUint32(s,i,!0),S.log(n.getUint32(e,!0),n.getUint32(s,!0)),0},args_get(e,s){let n=new DataView(t.inst.exports.memory.buffer),i=new Uint8Array(t.inst.exports.memory.buffer),_=s;for(let f=0;f<t.args.length;f++){n.setUint32(e,s,!0),e+=4;let c=new TextEncoder().encode(t.args[f]);i.set(c,s),n.setUint8(s+c.length,0),s+=c.length+1}return S.enabled&&S.log(new TextDecoder("utf-8").decode(i.slice(_,s))),0},environ_sizes_get(e,s){let n=new DataView(t.inst.exports.memory.buffer);n.setUint32(e,t.env.length,!0);let i=0;for(let _ of t.env)i+=new TextEncoder().encode(_).length+1;return n.setUint32(s,i,!0),S.log(n.getUint32(e,!0),n.getUint32(s,!0)),0},environ_get(e,s){let n=new DataView(t.inst.exports.memory.buffer),i=new Uint8Array(t.inst.exports.memory.buffer),_=s;for(let f=0;f<t.env.length;f++){n.setUint32(e,s,!0),e+=4;let c=new TextEncoder().encode(t.env[f]);i.set(c,s),n.setUint8(s+c.length,0),s+=c.length+1}return S.enabled&&S.log(new TextDecoder("utf-8").decode(i.slice(_,s))),0},clock_res_get(e,s){let n;switch(e){case 1:{n=5000n;break}case 0:{n=1000000n;break}default:return 52}return new DataView(t.inst.exports.memory.buffer).setBigUint64(s,n,!0),0},clock_time_get(e,s,n){let i=new DataView(t.inst.exports.memory.buffer);if(e===0)i.setBigUint64(n,BigInt(new Date().getTime())*1000000n,!0);else if(e==1){let _;try{_=BigInt(Math.round(performance.now()*1e6))}catch{_=0n}i.setBigUint64(n,_,!0)}else i.setBigUint64(n,0n,!0);return 0},fd_advise(e,s,n,i){return t.fds[e]!=null?0:8},fd_allocate(e,s,n){return t.fds[e]!=null?t.fds[e].fd_allocate(s,n):8},fd_close(e){if(t.fds[e]!=null){let s=t.fds[e].fd_close();return t.fds[e]=void 0,s}else return 8},fd_datasync(e){return t.fds[e]!=null?t.fds[e].fd_sync():8},fd_fdstat_get(e,s){if(t.fds[e]!=null){let{ret:n,fdstat:i}=t.fds[e].fd_fdstat_get();return i?.write_bytes(new DataView(t.inst.exports.memory.buffer),s),n}else return 8},fd_fdstat_set_flags(e,s){return t.fds[e]!=null?t.fds[e].fd_fdstat_set_flags(s):8},fd_fdstat_set_rights(e,s,n){return t.fds[e]!=null?t.fds[e].fd_fdstat_set_rights(s,n):8},fd_filestat_get(e,s){if(t.fds[e]!=null){let{ret:n,filestat:i}=t.fds[e].fd_filestat_get();return i?.write_bytes(new DataView(t.inst.exports.memory.buffer),s),n}else return 8},fd_filestat_set_size(e,s){return t.fds[e]!=null?t.fds[e].fd_filestat_set_size(s):8},fd_filestat_set_times(e,s,n,i){return t.fds[e]!=null?t.fds[e].fd_filestat_set_times(s,n,i):8},fd_pread(e,s,n,i,_){let f=new DataView(t.inst.exports.memory.buffer),c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let l=C.read_bytes_array(f,s,n),d=0;for(let u of l){let{ret:h,data:w}=t.fds[e].fd_pread(u.buf_len,i);if(h!=0)return f.setUint32(_,d,!0),h;if(c.set(w,u.buf),d+=w.length,i+=BigInt(w.length),w.length!=u.buf_len)break}return f.setUint32(_,d,!0),0}else return 8},fd_prestat_get(e,s){let n=new DataView(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let{ret:i,prestat:_}=t.fds[e].fd_prestat_get();return _?.write_bytes(n,s),i}else return 8},fd_prestat_dir_name(e,s,n){if(t.fds[e]!=null){let{ret:i,prestat:_}=t.fds[e].fd_prestat_get();if(_==null)return i;let f=_.inner.pr_name;return new Uint8Array(t.inst.exports.memory.buffer).set(f.slice(0,n),s),f.byteLength>n?37:0}else return 8},fd_pwrite(e,s,n,i,_){let f=new DataView(t.inst.exports.memory.buffer),c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let l=g.read_bytes_array(f,s,n),d=0;for(let u of l){let h=c.slice(u.buf,u.buf+u.buf_len),{ret:w,nwritten:I}=t.fds[e].fd_pwrite(h,i);if(w!=0)return f.setUint32(_,d,!0),w;if(d+=I,i+=BigInt(I),I!=h.byteLength)break}return f.setUint32(_,d,!0),0}else return 8},fd_read(e,s,n,i){let _=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let c=C.read_bytes_array(_,s,n),l=0;for(let d of c){let{ret:u,data:h}=t.fds[e].fd_read(d.buf_len);if(u!=0)return _.setUint32(i,l,!0),u;if(f.set(h,d.buf),l+=h.length,h.length!=d.buf_len)break}return _.setUint32(i,l,!0),0}else return 8},fd_readdir(e,s,n,i,_){let f=new DataView(t.inst.exports.memory.buffer),c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let l=0;for(;;){let{ret:d,dirent:u}=t.fds[e].fd_readdir_single(i);if(d!=0)return f.setUint32(_,l,!0),d;if(u==null)break;if(n-l<u.head_length()){l=n;break}let h=new ArrayBuffer(u.head_length());if(u.write_head_bytes(new DataView(h),0),c.set(new Uint8Array(h).slice(0,Math.min(h.byteLength,n-l)),s),s+=u.head_length(),l+=u.head_length(),n-l<u.name_length()){l=n;break}u.write_name_bytes(c,s,n-l),s+=u.name_length(),l+=u.name_length(),i=u.d_next}return f.setUint32(_,l,!0),0}else return 8},fd_renumber(e,s){if(t.fds[e]!=null&&t.fds[s]!=null){let n=t.fds[s].fd_close();return n!=0?n:(t.fds[s]=t.fds[e],t.fds[e]=void 0,0)}else return 8},fd_seek(e,s,n,i){let _=new DataView(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let{ret:f,offset:c}=t.fds[e].fd_seek(s,n);return _.setBigInt64(i,c,!0),f}else return 8},fd_sync(e){return t.fds[e]!=null?t.fds[e].fd_sync():8},fd_tell(e,s){let n=new DataView(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let{ret:i,offset:_}=t.fds[e].fd_tell();return n.setBigUint64(s,_,!0),i}else return 8},fd_write(e,s,n,i){let _=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let c=g.read_bytes_array(_,s,n),l=0;for(let d of c){let u=f.slice(d.buf,d.buf+d.buf_len),{ret:h,nwritten:w}=t.fds[e].fd_write(u);if(h!=0)return _.setUint32(i,l,!0),h;if(l+=w,w!=u.byteLength)break}return _.setUint32(i,l,!0),0}else return 8},path_create_directory(e,s,n){let i=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let _=new TextDecoder("utf-8").decode(i.slice(s,s+n));return t.fds[e].path_create_directory(_)}else return 8},path_filestat_get(e,s,n,i,_){let f=new DataView(t.inst.exports.memory.buffer),c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let l=new TextDecoder("utf-8").decode(c.slice(n,n+i)),{ret:d,filestat:u}=t.fds[e].path_filestat_get(s,l);return u?.write_bytes(f,_),d}else return 8},path_filestat_set_times(e,s,n,i,_,f,c){let l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let d=new TextDecoder("utf-8").decode(l.slice(n,n+i));return t.fds[e].path_filestat_set_times(s,d,_,f,c)}else return 8},path_link(e,s,n,i,_,f,c){let l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null&&t.fds[_]!=null){let d=new TextDecoder("utf-8").decode(l.slice(n,n+i)),u=new TextDecoder("utf-8").decode(l.slice(f,f+c)),{ret:h,inode_obj:w}=t.fds[e].path_lookup(d,s);return w==null?h:t.fds[_].path_link(u,w,!1)}else return 8},path_open(e,s,n,i,_,f,c,l,d){let u=new DataView(t.inst.exports.memory.buffer),h=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let w=new TextDecoder("utf-8").decode(h.slice(n,n+i));S.log(w);let{ret:I,fd_obj:v}=t.fds[e].path_open(s,w,_,f,c,l);if(I!=0)return I;t.fds.push(v);let X=t.fds.length-1;return u.setUint32(d,X,!0),0}else return 8},path_readlink(e,s,n,i,_,f){let c=new DataView(t.inst.exports.memory.buffer),l=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let d=new TextDecoder("utf-8").decode(l.slice(s,s+n));S.log(d);let{ret:u,data:h}=t.fds[e].path_readlink(d);if(h!=null){let w=new TextEncoder().encode(h);if(w.length>_)return c.setUint32(f,0,!0),8;l.set(w,i),c.setUint32(f,w.length,!0)}return u}else return 8},path_remove_directory(e,s,n){let i=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let _=new TextDecoder("utf-8").decode(i.slice(s,s+n));return t.fds[e].path_remove_directory(_)}else return 8},path_rename(e,s,n,i,_,f){let c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null&&t.fds[i]!=null){let l=new TextDecoder("utf-8").decode(c.slice(s,s+n)),d=new TextDecoder("utf-8").decode(c.slice(_,_+f)),{ret:u,inode_obj:h}=t.fds[e].path_unlink(l);if(h==null)return u;if(u=t.fds[i].path_link(d,h,!0),u!=0&&t.fds[e].path_link(l,h,!0)!=0)throw"path_link should always return success when relinking an inode back to the original place";return u}else return 8},path_symlink(e,s,n,i,_){let f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[n]!=null){let c=new TextDecoder("utf-8").decode(f.slice(e,e+s)),l=new TextDecoder("utf-8").decode(f.slice(i,i+_));return 58}else return 8},path_unlink_file(e,s,n){let i=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[e]!=null){let _=new TextDecoder("utf-8").decode(i.slice(s,s+n));return t.fds[e].path_unlink_file(_)}else return 8},poll_oneoff(e,s,n){if(n===0)return 28;if(n>1)return S.log("poll_oneoff: only a single subscription is supported"),58;let i=new DataView(t.inst.exports.memory.buffer),_=L.read_bytes(i,e),f=_.eventtype,c=_.clockid,l=_.timeout;if(f!==M)return S.log("poll_oneoff: only clock subscriptions are supported"),58;let d;if(c===1)d=()=>BigInt(Math.round(performance.now()*1e6));else if(c===0)d=()=>BigInt(new Date().getTime())*1000000n;else return 28;let u=(_.flags&Z)!==0?l:d()+l;for(;u>d(););return new U(_.userdata,0,f).write_bytes(i,s),0},proc_exit(e){throw new b(e)},proc_raise(e){throw"raised signal "+e},sched_yield(){},random_get(e,s){let n=new Uint8Array(t.inst.exports.memory.buffer).subarray(e,e+s);if("crypto"in globalThis&&(typeof SharedArrayBuffer>"u"||!(t.inst.exports.memory.buffer instanceof SharedArrayBuffer)))for(let i=0;i<s;i+=65536)crypto.getRandomValues(n.subarray(i,i+65536));else for(let i=0;i<s;i++)n[i]=Math.random()*256|0},sock_recv(e,s,n){throw"sockets not supported"},sock_send(e,s,n){throw"sockets not supported"},sock_shutdown(e,s){throw"sockets not supported"},sock_accept(e,s){throw"sockets not supported"}}}};var m=class{fd_allocate(r,a){return 58}fd_close(){return 0}fd_fdstat_get(){return{ret:58,fdstat:null}}fd_fdstat_set_flags(r){return 58}fd_fdstat_set_rights(r,a){return 58}fd_filestat_get(){return{ret:58,filestat:null}}fd_filestat_set_size(r){return 58}fd_filestat_set_times(r,a,o){return 58}fd_pread(r,a){return{ret:58,data:new Uint8Array}}fd_prestat_get(){return{ret:58,prestat:null}}fd_pwrite(r,a){return{ret:58,nwritten:0}}fd_read(r){return{ret:58,data:new Uint8Array}}fd_readdir_single(r){return{ret:58,dirent:null}}fd_seek(r,a){return{ret:58,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:58,offset:0n}}fd_write(r){return{ret:58,nwritten:0}}path_create_directory(r){return 58}path_filestat_get(r,a){return{ret:58,filestat:null}}path_filestat_set_times(r,a,o,E,t){return 58}path_link(r,a,o){return 58}path_unlink(r){return{ret:58,inode_obj:null}}path_lookup(r,a){return{ret:58,inode_obj:null}}path_open(r,a,o,E,t,e){return{ret:54,fd_obj:null}}path_readlink(r){return{ret:58,data:null}}path_remove_directory(r){return 58}path_rename(r,a,o){return 58}path_unlink_file(r){return 58}},T=class R{static issue_ino(){return R.next_ino++}static root_ino(){return 0n}constructor(){this.ino=R.issue_ino()}};T.next_ino=1n;var x=class R extends m{fd_filestat_get(){return{ret:0,filestat:new y(this.ino,P,BigInt(0))}}fd_fdstat_get(){let r=new A(P,0);return r.fs_rights_base=BigInt(64),{ret:0,fdstat:r}}fd_write(r){return this.write(r),{ret:0,nwritten:r.byteLength}}static lineBuffered(r){let a=new TextDecoder("utf-8",{fatal:!1}),o="";return new R(E=>{o+=a.decode(E,{stream:!0});let t=o.split(`
`);for(let[e,s]of t.entries())e<t.length-1?r(s):o=s})}constructor(r){super(),this.ino=T.issue_ino(),this.write=r}};var H=class{#e=0;#t=new Map;newJSVal(r){let a=++this.#e;return this.#t.set(a,r),a}getJSVal(r){if(!this.#t.has(r))throw new WebAssembly.RuntimeError(`getJSVal(${r})`);return this.#t.get(r)}freeJSVal(r){if(!this.#t.delete(r))throw new WebAssembly.RuntimeError(`freeJSVal(${r})`)}},at=await(async()=>{if(globalThis.setImmediate)return globalThis.setImmediate;if(globalThis.Deno)try{return(await import("node:timers")).setImmediate}catch{}if(globalThis.scheduler)return(R,...r)=>scheduler.postTask(()=>R(...r));if(globalThis.MessageChannel){class R{#e=[];#t=new MessageChannel;constructor(){this.#t.port1.addEventListener("message",()=>{this.#e.pop()()}),this.#t.port1.start()}setImmediate(o,...E){this.#e.push(()=>o(...E)),this.#t.port2.postMessage(void 0)}}let r=new R;return(a,...o)=>r.setImmediate(a,...o)}return(R,...r)=>setTimeout(R,0,...r)})(),j=R=>{let r=new H,a=globalThis.FinalizationRegistry?new FinalizationRegistry(o=>R.rts_freeStablePtr(o)):{register:()=>{},unregister:()=>!0};return{newJSVal:o=>r.newJSVal(o),getJSVal:o=>r.getJSVal(o),freeJSVal:o=>r.freeJSVal(o),scheduleWork:()=>at(R.rts_schedulerLoop),ZC4ZCimplizm3zi0zi0zi0zminplacezmimplizmwasmZCMainZC:o=>console.log(o),ZC0ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:(o,E)=>o.reject(new WebAssembly.RuntimeError(E)),ZC2ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:(o,E)=>o.resolve(E),ZC18ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:(o,E)=>o.resolve(E),ZC19ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:o=>o.resolve(),ZC20ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:o=>{o.throwTo=()=>{}},ZC21ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:(o,E)=>{o.throwTo=t=>R.rts_promiseThrowTo(E,t)},ZC22ZCghczminternalZCGHCziInternalziWasmziPrimziExportsZC:()=>{let o,E,t=new Promise((e,s)=>{o=e,E=s});return t.resolve=o,t.reject=E,t},ZC0ZCghczminternalZCGHCziInternalziWasmziPrimziTypesZC:o=>`${o.stack?o.stack:o}`,ZC1ZCghczminternalZCGHCziInternalziWasmziPrimziTypesZC:(o,E)=>new TextDecoder("utf-8",{fatal:!0}).decode(new Uint8Array(R.memory.buffer,o,E)),ZC2ZCghczminternalZCGHCziInternalziWasmziPrimziTypesZC:(o,E,t)=>new TextEncoder().encodeInto(o,new Uint8Array(R.memory.buffer,E,t)).written,ZC3ZCghczminternalZCGHCziInternalziWasmziPrimziTypesZC:o=>o.length,ZC4ZCghczminternalZCGHCziInternalziWasmziPrimziTypesZC:o=>{try{a.unregister(o)}catch{}},ZC18ZCghczminternalZCGHCziInternalziWasmziPrimziImportsZC:(o,E)=>o.then(()=>R.rts_promiseResolveUnit(E),t=>R.rts_promiseReject(E,t)),ZC0ZCghczminternalZCGHCziInternalziWasmziPrimziConcziInternalZC:async o=>new Promise(E=>setTimeout(E,o/1e3))}};var K={prompt:"IMP> ",welcome:"Welcome to the IMP REPL! Enter :help to list available metacommands."},Y=class extends globalThis.Terminal{constructor(){super({cursorBlink:!0}),this.config=K,this.open(document.getElementById("terminal")),this.writeln(this.config.welcome),this.write(K.prompt)}},V=class{constructor(){this.terminal=new Y,this.exports={}}async init(){let r=[[],x.lineBuffered(this.terminal.writeln),x.lineBuffered(E=>console.warn(`[WASI stderr] ${E}`))],a=new z([],[],r),o=await WebAssembly.instantiateStreaming(fetch("./impli.wasm"),{wasi_snapshot_preview1:a.wasiImport,ghc_wasm_jsffi:j(this.exports)});return a.initialize(o.instance),Object.assign(this.exports,o.instance.exports),this.pointer=this.exports.initialize(),this}async interpret(r){let a=await this.exports.execute(this.pointer,r);return JSON.parse(a)}};(async()=>globalThis.impli=await new V().init())();
