name: Build binary and release

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-wasm:
    name: Build WASM binary
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            extra-substituters = https://ghc-wasm-meta.cachix.org
            extra-trusted-public-keys = ghc-wasm-meta.cachix.org-1:6C9S967v6XvAizKovS/I844z6o0qR2r3/2DkY7vXGgY=

      - name: Build WASM binary
        run: |
          # Build the WASM binary using nix build with --accept-flake-config to trust binary cache
          nix build .#impli-web -L --accept-flake-config

          # Copy the built WASM binary with the correct name (impli.wasm)
          mkdir -p artifacts
          cp result/bin/impli-web.wasm artifacts/impli.wasm

          echo "WASM binary built successfully"
          ls -lh artifacts/impli.wasm

      - name: Upload WASM to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-binary
          path: artifacts/impli.wasm

  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Haskell
        id: setup-haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: "9.12.2"
          cabal-version: "3.12"

      - name: Cache Cabal store
        uses: actions/cache@v4
        with:
          path: ${{ steps.setup-haskell.outputs.cabal-store }}
          key: ${{ runner.os }}-cabal

      - name: Build impli
        run: |
          cabal update
          cabal build exe:impli

      - name: Prepare native binaries
        shell: bash
        run: |
          mkdir -p artifacts

          # Platform detection
          ARCH=$(uname -m)

          # Normalize architecture name
          if [[ "$ARCH" == "arm64" ]]; then
            ARCH="aarch64"
          elif [[ "$ARCH" == "x86_64" || "$ARCH" == "amd64" ]]; then
            ARCH="x86_64"
          fi

          # Normalize OS name
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            OS="windows"
            EXT=".exe"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            OS="darwin"
            EXT=""
          else
            OS="linux"
            EXT=""
          fi

          SYSTEM="${ARCH}-${OS}"

          # Use cabal list-bin to locate the binary
          BIN=$(cabal list-bin exe:impli)

          if [[ -z "$BIN" || ! -f "$BIN" ]]; then
            echo "ERROR: Could not find compiled binary"
            exit 1
          fi

          # Copy and rename with platform suffix
          cp "$BIN" "artifacts/impli-${SYSTEM}${EXT}"

          # Make it executable and strip on Unix
          if [[ "$OS" != "windows" ]]; then
            chmod +x "artifacts/impli-${SYSTEM}${EXT}"
            strip "artifacts/impli-${SYSTEM}${EXT}" 2>/dev/null || true
          fi

      - name: Get latest Git tag (fallback)
        if: github.event_name == 'workflow_dispatch'
        id: get_tag
        run: |
          echo "tag=$(git describe --tags --abbrev=0)" >> "$GITHUB_OUTPUT"

      - name: Upload native binaries to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: native-binaries-${{ matrix.os }}
          path: artifacts/*

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, build-wasm]
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Copy all native binaries
          if ls all-artifacts/native-binaries-*/impli-* 1> /dev/null 2>&1; then
            find all-artifacts/native-binaries-* -type f -exec cp {} release-assets/ \;
          else
            echo "ERROR: No native binaries found in artifacts"
            exit 1
          fi
          
          # Copy WASM binary
          if [ -f all-artifacts/wasm-binary/impli.wasm ]; then
            cp all-artifacts/wasm-binary/impli.wasm release-assets/
          else
            echo "ERROR: WASM binary not found"
            exit 1
          fi
          
          echo "Release assets prepared:"
          ls -lh release-assets/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
