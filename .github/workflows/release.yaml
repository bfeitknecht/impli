name: Build binary and release

on:
    push:
        tags:
            - "v*"
    pull_request:
        branches: [master]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        name: Build on ${{ matrix.os }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]

        steps:
            - name: Checkout repo
              uses: actions/checkout@v4

            - name: Install Nix (Linux only)
              if: runner.os == 'Linux'
              uses: cachix/install-nix-action@v24
              with:
                  nix_path: nixpkgs=channel:nixos-unstable
                  extra_nix_config: |
                      experimental-features = nix-command flakes

            - name: Build with Nix (Linux only)
              if: runner.os == 'Linux'
              run: |
                  nix build .#impli -L

            - name: Set up Haskell (non-Linux)
              if: runner.os != 'Linux'
              id: setup-haskell
              uses: haskell-actions/setup@v2
              with:
                  ghc-version: "9.10.2"
                  cabal-version: "3.12"

            - name: Cache Cabal store (non-Linux)
              if: runner.os != 'Linux'
              uses: actions/cache@v4
              with:
                  path: ${{ steps.setup-haskell.outputs.cabal-store }}
                  key: ${{ runner.os }}-cabal

            - name: Build impli (non-Linux)
              if: runner.os != 'Linux'
              run: |
                  cabal update
                  cabal build exe:impli

            - name: Upload executable to artifacts
              shell: bash
              run: |
                  mkdir -p artifacts

                  # Fallback platform detection
                  ARCH=$(uname -m)
                  OS=$(uname -s | tr '[:upper:]' '[:lower:]')

                  # Normalize architecture name
                  if [[ "$ARCH" == "arm64" ]]; then
                    ARCH="aarch64"
                  elif [[ "$ARCH" == "x86_64" || "$ARCH" == "amd64" ]]; then
                    ARCH="x86_64"
                  fi

                  # Normalize OS name
                  if [[ "$RUNNER_OS" == "Windows" ]]; then
                    OS="windows"
                    EXT=".exe"
                  elif [[ "$RUNNER_OS" == "macOS" ]]; then
                    OS="darwin"
                    EXT=""
                  else
                    OS="linux"
                    EXT=""
                  fi

                  PLATFORM="${ARCH}-${OS}"
                  BINARY_NAME="impli${EXT}"

                  echo "ðŸ” Looking for binary: $BINARY_NAME"

                  # For Linux with Nix build, look in result/bin/
                  if [[ "$RUNNER_OS" == "Linux" && -d "result/bin" ]]; then
                    BIN="result/bin/impli"
                  else
                    # Locate the binary (executable) in cabal build directory
                    BIN=$(find dist-newstyle -type f -name "$BINARY_NAME" | head -n 1)
                  fi

                  if [[ -z "$BIN" ]]; then
                    echo "âŒ ERROR: Could not find compiled binary '$BINARY_NAME'"
                    exit 1
                  fi

                  # Copy and rename with platform suffix first
                  cp "$BIN" "artifacts/impli-${PLATFORM}${EXT}"

                  # Make it executable and strip on Unix
                  if [[ "$OS" != "windows" ]]; then
                    chmod +x "artifacts/impli-${PLATFORM}${EXT}"
                    echo "ðŸ”§ Stripping binary to reduce size..."
                    strip -u -r "artifacts/impli-${PLATFORM}${EXT}" || echo "âš ï¸ strip failed, continuing..."
                  fi

                  echo "âœ… Binary copied to artifacts/impli-${PLATFORM}${EXT}"

            - name: Get latest Git tag (fallback)
              if: github.event_name == 'workflow_dispatch'
              id: get_tag
              run: |
                  echo "tag=$(git describe --tags --abbrev=0)" >> "$GITHUB_OUTPUT"

            - name: Upload to GitHub Release
              if: startsWith(github.ref, 'refs/tags/')
              uses: softprops/action-gh-release@v1
              with:
                  files: artifacts/*
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
