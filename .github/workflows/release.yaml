name: Build and Release

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
          - os: macos-latest
            arch: auto
          - os: windows-latest
            arch: x86_64

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Haskell
        id: setup-haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: "9.12.2"
          cabal-version: "3.12"

      - name: Cache Cabal store
        uses: actions/cache@v4
        with:
          path: ${{ steps.setup-haskell.outputs.cabal-store }}
          key: ${{ runner.os }}-${{ matrix.arch }}-cabal

      - name: Build impli
        run: |
          cabal update
          cabal build exe:impli

      - name: Prepare native binaries
        shell: bash
        run: |
          mkdir -p artifacts

          # Platform detection
          if [[ "${{ matrix.arch }}" == "auto" ]]; then
            ARCH=$(uname -m)
            # Normalize architecture name
            if [[ "$ARCH" == "arm64" ]]; then
              ARCH="aarch64"
            elif [[ "$ARCH" == "x86_64" || "$ARCH" == "amd64" ]]; then
              ARCH="x86_64"
            fi
          else
            ARCH="${{ matrix.arch }}"
          fi

          # Normalize OS name
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            OS="windows"
            EXT=".exe"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            OS="darwin"
            EXT=""
          else
            OS="linux"
            EXT=""
          fi

          SYSTEM="${ARCH}-${OS}"

          # Use cabal list-bin to locate the binary
          BIN=$(cabal list-bin exe:impli)

          if [[ -z "$BIN" || ! -f "$BIN" ]]; then
            echo "ERROR: Could not find compiled binary"
            exit 1
          fi

          # Copy and rename with platform suffix
          cp "$BIN" "artifacts/impli-${SYSTEM}${EXT}"

          # Make it executable and strip on Unix
          if [[ "$OS" != "windows" ]]; then
            chmod +x "artifacts/impli-${SYSTEM}${EXT}"
            strip "artifacts/impli-${SYSTEM}${EXT}" 2>/dev/null || true
          fi

      - name: Upload native binaries
        uses: actions/upload-artifact@v4
        with:
          name: impli-${{ matrix.os }}-${{ matrix.arch }}
          path: artifacts/*

  build-wasm:
    name: Build WASM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            extra-substituters = https://ghc-wasm-meta.cachix.org
            extra-trusted-public-keys = ghc-wasm-meta.cachix.org-1:6C9S967v6XvAizKovS/I844z6o0qR2r3/2DkY7vXGgY=

      - name: Build WASM binary
        run: |
          nix build .#impli-web -L --accept-flake-config
          mkdir -p artifacts
          cp result/bin/impli-web.wasm artifacts/impli.wasm

      - name: Upload WASM binary
        uses: actions/upload-artifact@v4
        with:
          name: impli-wasm
          path: artifacts/impli.wasm

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build, build-wasm]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release

          # Copy all binaries (native and WASM)
          find artifacts/impli-* -type f -exec cp {} release/ \;

          # List release files
          echo "Release files ready:"
          ls -lh release/

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
