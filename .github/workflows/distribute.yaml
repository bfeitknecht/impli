name: Distribute packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # Hackage publication
  hackage:
    name: Publish to Hackage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Haskell
        uses: haskell-actions/setup@v2
        with:
          ghc-version: '9.10.2'
          cabal-version: '3.12'

      - name: Build source distribution
        run: |
          cabal update
          cabal sdist

      - name: Publish to Hackage
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cabal upload --publish dist-newstyle/sdist/impli-*.tar.gz
        env:
          HACKAGE_TOKEN: ${{ secrets.HACKAGE_TOKEN }}

  # Create distribution artifacts
  build-artifacts:
    name: Build distribution artifacts
    runs-on: ubuntu-latest
    needs: []
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Copy Nix package
        run: cp -r nixpkgs artifacts/

      - name: Copy Homebrew formula
        run: cp homebrew/impli.rb artifacts/

      - name: Copy Debian package files
        run: cp -r debian artifacts/

      - name: Copy AUR PKGBUILD
        run: cp aur/PKGBUILD artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: distribution-files
          path: artifacts/

  # Generate Homebrew formula with correct SHA
  update-homebrew:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Calculate SHA256
        id: calc_sha
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          curl -L -o /tmp/impli.tar.gz "https://github.com/bfeitknecht/impli/archive/refs/tags/v${VERSION}.tar.gz"
          SHA256=$(sha256sum /tmp/impli.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SHA256=${{ steps.calc_sha.outputs.SHA256 }}
          sed -i "s|url \".*\"|url \"https://github.com/bfeitknecht/impli/archive/refs/tags/v${VERSION}.tar.gz\"|" homebrew/impli.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" homebrew/impli.rb

      - name: Upload updated formula
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula
          path: homebrew/impli.rb

  # Update AUR PKGBUILD with correct SHA
  update-aur:
    name: Update AUR PKGBUILD
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Calculate SHA256
        id: calc_sha
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          curl -L -o /tmp/impli.tar.gz "https://github.com/bfeitknecht/impli/archive/refs/tags/v${VERSION}.tar.gz"
          SHA256=$(sha256sum /tmp/impli.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT

      - name: Update PKGBUILD
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          SHA256=${{ steps.calc_sha.outputs.SHA256 }}
          sed -i "s|pkgver=.*|pkgver=${VERSION}|" aur/PKGBUILD
          sed -i "s|sha256sums=.*|sha256sums=('${SHA256}')|" aur/PKGBUILD

      - name: Upload updated PKGBUILD
        uses: actions/upload-artifact@v4
        with:
          name: aur-pkgbuild
          path: aur/PKGBUILD

  # Update Debian changelog
  update-debian:
    name: Update Debian package
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Update Debian changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          DATE=$(date -R)
          cat > debian/changelog << EOF
          impli (${VERSION}-1) unstable; urgency=low

            * New upstream release ${VERSION}.

           -- Basil Feitknecht <bfeitknecht@ethz.ch>  ${DATE}
          EOF

      - name: Upload updated Debian files
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: debian/

  # Create release with updated distribution files
  create-release-notes:
    name: Create release notes
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: [update-homebrew, update-aur, update-debian]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          ## Distribution

          ### Hackage
          Published to Hackage: https://hackage.haskell.org/package/impli

          ### Homebrew
          Install via Homebrew (formula needs to be submitted to homebrew-core):
          ```bash
          brew install impli
          ```
          
          Or install from this repository:
          ```bash
          brew install bfeitknecht/tap/impli
          ```

          ### Nix/NixOS
          Install via Nix (package needs to be submitted to nixpkgs):
          ```bash
          nix-env -iA nixpkgs.impli
          ```

          ### Arch Linux (AUR)
          Install via AUR helper (package needs to be published to AUR):
          ```bash
          yay -S impli
          ```

          ### Debian/Ubuntu
          Build and install from source using the debian/ directory.

          ---

          See the attached artifacts for the latest distribution files.
          EOF

      - name: Append to release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          files: |
            homebrew-formula/impli.rb
            aur-pkgbuild/PKGBUILD
            debian-package/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
